# Azure Pipelines YAML for MuleSoft Projects
# ‚úÖ FIXED: Anypoint CLI authentication with proper credential handling
# ‚úÖ Complete pipeline with Maven 3.9.10 + All features enabled

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_HOME
    value: /opt/maven
  - name: PROJECT_NAME
    value: $[variables.projectName]
  - name: MULE_ORG
    value: $[variables.muleOrg]
  - name: MULE_ORG_ID
    value: $[variables.muleOrgId]

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # =============================================
          # STEP 1: Download settings.xml (Secure Files)
          # =============================================
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings from Secure Files'
            inputs:
              secureFile: 'settings.xml'
          
          # =============================================
          # STEP 2: Install Maven 3.9.10 (Robust)
          # =============================================
          - script: |
              set -e
              
              echo "=================================================="
              echo "  Installing Maven $(MAVEN_VERSION)"
              echo "=================================================="
              echo ""
              
              # Show current state
              echo "üìã Pre-installed Maven:"
              mvn --version 2>/dev/null || echo "   Not found"
              echo ""
              
              # Download configuration
              MAVEN_URL="https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz"
              MAVEN_ARCHIVE="maven.tar.gz"
              MAVEN_DIR="apache-maven-$(MAVEN_VERSION)"
              
              echo "üì• Downloading Maven $(MAVEN_VERSION)..."
              
              # Try wget first
              if wget --progress=dot:giga --timeout=60 --tries=3 -O "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
                echo "‚úÖ Downloaded with wget"
              elif curl -fsSL --progress-bar --max-time 120 --retry 3 -o "$MAVEN_ARCHIVE" "$MAVEN_URL"; then
                echo "‚úÖ Downloaded with curl"
              else
                echo "‚ùå ERROR: Download failed with both wget and curl"
                exit 1
              fi
              
              # Verify download
              FILE_SIZE=$(stat -c%s "$MAVEN_ARCHIVE" 2>/dev/null || stat -f%z "$MAVEN_ARCHIVE" 2>/dev/null)
              echo "   File size: $(echo $FILE_SIZE | numfmt --to=iec-i --suffix=B 2>/dev/null || echo ${FILE_SIZE} bytes)"
              
              if [ "$FILE_SIZE" -lt 8000000 ]; then
                echo "‚ùå ERROR: File too small ($FILE_SIZE bytes)"
                exit 1
              fi
              
              # Extract
              echo ""
              echo "üì¶ Extracting..."
              tar -xzf "$MAVEN_ARCHIVE"
              
              if [ ! -d "$MAVEN_DIR" ]; then
                echo "‚ùå ERROR: Directory not found after extraction"
                ls -la
                exit 1
              fi
              
              # Install
              echo "üì• Installing to $(MAVEN_HOME)..."
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv "$MAVEN_DIR" $(MAVEN_HOME)
              sudo chmod -R 755 $(MAVEN_HOME)
              
              # Verify
              if [ ! -f $(MAVEN_HOME)/bin/mvn ]; then
                echo "‚ùå ERROR: Maven binary not found"
                exit 1
              fi
              
              echo ""
              echo "‚úÖ Maven installed:"
              $(MAVEN_HOME)/bin/mvn --version
              
              # Verify version
              ACTUAL_VERSION=$($(MAVEN_HOME)/bin/mvn --version | grep "Apache Maven" | awk '{print $3}')
              if [ "$ACTUAL_VERSION" = "$(MAVEN_VERSION)" ]; then
                echo "‚úÖ Version verified: $ACTUAL_VERSION"
              else
                echo "‚ö†Ô∏è Version mismatch (expected $(MAVEN_VERSION), got $ACTUAL_VERSION)"
              fi
              
              # Cleanup
              rm -f "$MAVEN_ARCHIVE"
              echo ""
              echo "‚úÖ Installation complete"
              
            displayName: 'Install Maven 3.9.10'
          
          # =============================================
          # STEP 3: Install settings.xml
          # =============================================
          - script: |
              echo "üì¶ Installing Maven settings.xml..."
              mkdir -p ~/.m2
              
              if [ ! -f "$(mavenSettings.secureFilePath)" ]; then
                echo "‚ùå ERROR: settings.xml not found"
                exit 1
              fi
              
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ settings.xml installed"
                echo "   Location: ~/.m2/settings.xml"
                FILE_SIZE=$(stat -c%s ~/.m2/settings.xml 2>/dev/null || stat -f%z ~/.m2/settings.xml 2>/dev/null)
                echo "   Size: $FILE_SIZE bytes"
              else
                echo "‚ùå ERROR: Installation failed"
                exit 1
              fi
              
              echo ""
              echo "üìÑ Structure (sanitized):"
              grep -E '<server>|<id>|</server>' ~/.m2/settings.xml | head -20 || echo "   Could not parse"
              
            displayName: 'Install Maven Settings'

          # =============================================
          # STEP 4: Setup Java 17
          # =============================================
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # =============================================
          # STEP 5: Verify Environment
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Build Environment"
              echo "=================================================="
              echo ""
              
              echo "‚òï Java:"
              java -version 2>&1 | head -3
              echo "   JAVA_HOME: $JAVA_HOME"
              echo ""
              
              echo "üì¶ Maven:"
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              mvn --version
              echo "   M2_HOME: $M2_HOME"
              echo ""
              
              echo "‚öôÔ∏è Settings:"
              if [ -f ~/.m2/settings.xml ]; then
                echo "   ‚úÖ settings.xml exists"
              else
                echo "   ‚ùå settings.xml missing"
                exit 1
              fi
              echo ""
              
              echo "üìã POM:"
              if [ -f pom.xml ]; then
                echo "   ‚úÖ pom.xml found"
                grep -E "mule.maven.plugin.version|maven.compiler.source|app.runtime" pom.xml | head -5 || true
              else
                echo "   ‚ö†Ô∏è pom.xml not found"
              fi
              
              echo ""
              echo "‚úÖ Verification complete"
              
            displayName: 'Verify Build Environment'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 6: Cache Maven Dependencies
          # =============================================
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # =============================================
          # STEP 7: Install Anypoint CLI (FIXED)
          # =============================================
          - script: |
              echo "=================================================="
              echo "  Installing Anypoint CLI"
              echo "=================================================="
              echo ""
              
              # Install Anypoint CLI globally
              echo "üì¶ Installing Anypoint CLI..."
              npm install -g anypoint-cli@latest
              
              echo ""
              echo "‚úÖ Anypoint CLI installed:"
              anypoint-cli --version
              echo ""
              
              # ‚úÖ FIX: Configure credentials BEFORE running any commands
              echo "üîê Configuring Anypoint credentials..."
              
              # Create .anypoint directory
              mkdir -p ~/.anypoint
              
              # Check which authentication method is available
              if [ -n "$(anypointClientId)" ] && [ -n "$(anypointClientSecret)" ]; then
                echo "   Using Connected App authentication"
                
                # Create credentials.json with Connected App
                cat > ~/.anypoint/credentials.json <<EOF
{
  "default": {
    "client_id": "$(anypointClientId)",
    "client_secret": "$(anypointClientSecret)",
    "organization": "$(MULE_ORG)",
    "environment": "Sandbox",
    "host": "anypoint.mulesoft.com"
  }
}
EOF
                
              elif [ -n "$(anypointUsername)" ] && [ -n "$(anypointPassword)" ]; then
                echo "   Using username/password authentication"
                
                # Create credentials.json with user credentials
                cat > ~/.anypoint/credentials.json <<EOF
{
  "default": {
    "username": "$(anypointUsername)",
    "password": "$(anypointPassword)",
    "organization": "$(MULE_ORG)",
    "environment": "Sandbox",
    "host": "anypoint.mulesoft.com"
  }
}
EOF
                
              else
                echo "‚ö†Ô∏è WARNING: No Anypoint credentials configured"
                echo "   Required variables:"
                echo "   - Option 1: anypointClientId + anypointClientSecret"
                echo "   - Option 2: anypointUsername + anypointPassword"
                echo ""
                echo "   Anypoint CLI commands will be skipped"
                exit 0
              fi
              
              # Verify credentials file
              if [ -f ~/.anypoint/credentials.json ]; then
                echo "‚úÖ Credentials file created"
                echo "   Location: ~/.anypoint/credentials.json"
                echo ""
                
                # Show structure (sanitized)
                echo "üìÑ Credentials structure:"
                if [ -n "$(anypointClientId)" ]; then
                  echo "   Authentication: Connected App (client_id)"
                else
                  echo "   Authentication: Username/Password"
                fi
                echo "   Organization: $(MULE_ORG)"
                echo "   Environment: Sandbox"
              else
                echo "‚ùå ERROR: Failed to create credentials file"
                exit 1
              fi
              
              echo ""
              echo "=================================================="
              echo "  ‚úÖ Anypoint CLI Setup Complete"
              echo "=================================================="
              
            displayName: 'Install and Configure Anypoint CLI'
            env:
              # These variables should be defined in the variable group
              ANYPOINT_CLIENT_ID: $(anypointClientId)
              ANYPOINT_CLIENT_SECRET: $(anypointClientSecret)
              ANYPOINT_USERNAME: $(anypointUsername)
              ANYPOINT_PASSWORD: $(anypointPassword)

         # =============================================
          # STEP 8: API Governance Validation (FIXED)
          # =============================================
          - script: |
              echo "=================================================="
              echo "  API Governance Validation"
              echo "=================================================="
              echo ""
              
              # Check if Anypoint credentials are configured
              if [ ! -f ~/.anypoint/credentials.json ]; then
                echo "‚ö†Ô∏è Anypoint credentials not configured"
                echo "   Skipping governance validation..."
                exit 0
              fi
              
              echo "üîç Checking for governance ruleset..."
              
              # Check if ruleset.yaml exists
              if [ ! -f "ruleset.yaml" ]; then
                echo "‚ö†Ô∏è No ruleset.yaml found in project root"
                echo "   Skipping governance validation..."
                echo ""
                echo "   To enable governance:"
                echo "   1. Create ruleset.yaml in project root"
                echo "   2. Enable API Governance in Anypoint Platform"
                echo "   3. Grant 'Design Center Developer' scope to Connected App"
                exit 0
              fi
              
              echo "‚úÖ ruleset.yaml found"
              echo ""
              
              # Create project ZIP if needed
              if [ ! -f "$(PROJECT_NAME).zip" ]; then
                echo "üì¶ Creating project ZIP..."
                zip -r $(PROJECT_NAME).zip . -x "*.git*" -x "target/*" -x "*.zip"
                echo "‚úÖ ZIP created: $(PROJECT_NAME).zip"
              fi
              
              echo ""
              echo "üõ°Ô∏è Running governance validation..."
              echo "   Organization: $(MULE_ORG)"
              echo "   Ruleset: ruleset.yaml"
              echo ""
              
              # Run validation using default profile (credentials.json)
              anypoint-cli governance api validate \
                --rulesets ruleset.yaml \
                $(PROJECT_NAME).zip || {
                  echo ""
                  echo "‚ö†Ô∏è Governance validation failed"
                  echo "   This is non-blocking - build will continue"
                  echo ""
                  echo "   Common issues:"
                  echo "   - API Governance not enabled for organization"
                  echo "   - Connected App missing required scopes"
                  echo "   - Ruleset syntax errors"
                  echo "   - API definition doesn't match ruleset"
                }
              
              echo ""
              echo "=================================================="
              echo "  Governance validation completed"
              echo "=================================================="
              
            displayName: 'API Governance Validation'
            continueOnError: true
            condition: and(succeeded(), ne(variables['MULE_ORG'], ''))

          # =============================================
          # STEP 9: Maven Validate
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üîç Running Maven validate..."
              echo ""
              
              mvn validate \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml \
                -e
              
              echo ""
              echo "‚úÖ Validation completed"
              
            displayName: 'Maven Validate'
            continueOnError: true
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 10: Maven Package
          # =============================================
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "üì¶ Running Maven package..."
              echo ""
              
              mvn clean package \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -DskipTests \
                -s ~/.m2/settings.xml \
                -e
              
              echo ""
              echo "‚úÖ Package completed"
              echo ""
              
              # Show artifacts
              echo "üì¶ Build Artifacts:"
              if [ -d target ]; then
                ls -lh target/*.jar 2>/dev/null || ls -lh target/ || echo "   No JAR files found"
              else
                echo "   ‚ö†Ô∏è target/ directory not found"
              fi
              
            displayName: 'Maven Package'
            env:
              M2_HOME: $(MAVEN_HOME)

          # =============================================
          # STEP 11: Copy Build Artifacts
          # =============================================
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # =============================================
          # STEP 12: Publish Pipeline Artifacts
          # =============================================
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'
